<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyVoiceger - FFmpeg-FreeéŸ³å£°å¤‰æ›</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-music"></i> MyVoiceger</h1>
            <p>FFmpeg-Freeè»½é‡éŸ³å£°å¤‰æ›ã‚¢ãƒ—ãƒª</p>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container">
        <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- ã‚¹ãƒ†ãƒƒãƒ—é€²è¡ŒçŠ¶æ³ -->
        <div class="progress-container">
            <div class="step-indicators">
                <div class="step {% if (session.step_completed | default({})).get('upload', false) %}active{% endif %}" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                </div>
                <div class="step {% if (session.step_completed | default({})).get('preprocessing', false) %}active{% endif %}" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">å‰å‡¦ç†</div>
                </div>
                <div class="step {% if (session.step_completed | default({})).get('conversion', false) %}active{% endif %}" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">éŸ³å£°å¤‰æ›</div>
                </div>
                <div class="step {% if (session.step_completed | default({})).get('postprocessing', false) %}active{% endif %}" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">å¾Œå‡¦ç†</div>
                </div>
                <div class="step {% if (session.step_completed | default({})).get('analysis', false) %}active{% endif %}" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">AIåˆ†æ</div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <section class="step-section" id="step1">
            <h2><i class="fas fa-upload"></i> ã‚¹ãƒ†ãƒƒãƒ—1: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <!-- æ¥½æ›²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="upload-card">
                <h3>ğŸµ æ¥½æ›²ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <form action="{{ url_for('upload_music') }}" method="post" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <input type="file" id="music_file" name="music_file" accept=".mp3,.wav,.m4a,.flac" required>
                        <label for="music_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            æ¥½æ›²ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </label>
                        <div class="file-info" id="music_file_info">
                            {% if session.files.music %}
                                <p><strong>{{ session.files.music.original_name }}</strong> ({{ session.files.music.size_mb }}MB)</p>
                                <p class="upload-success"><i class="fas fa-check"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</p>
                            {% endif %}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if (session.step_completed | default({})).get('upload', false) %}disabled{% endif %}>
                        <i class="fas fa-upload"></i> æ¥½æ›²ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </form>
            </div>

            <!-- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="upload-card">
                <h3>ğŸ¤ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <form action="{{ url_for('upload_voice') }}" method="post" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <input type="file" id="target_voice_file" name="target_voice_file" accept=".mp3,.wav,.m4a,.flac" required>
                        <label for="target_voice_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŸ³å£°ã‚’é¸æŠ
                        </label>
                        <div class="file-info" id="target_voice_file_info">
                            {% if session.files.target_voice_upload %}
                                <p><strong>{{ session.files.target_voice_upload.original_name }}</strong> ({{ session.files.target_voice_upload.size_mb }}MB)</p>
                                <p class="upload-success"><i class="fas fa-check"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</p>
                            {% endif %}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if not session.files.music %}disabled{% endif %}>
                        <i class="fas fa-upload"></i> ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŸ³å£°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </form>
            </div>
        </section>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: å‰å‡¦ç† -->
        <section class="step-section {% if not (session.step_completed | default({})).get('upload', false) %}disabled{% endif %}" id="step2">
            <h2><i class="fas fa-cogs"></i> ã‚¹ãƒ†ãƒƒãƒ—2: å‰å‡¦ç†</h2>
            
            <form action="{{ url_for('preprocess') }}" method="post">
                <div class="preprocessing-card">
                    <h3>å‰å‡¦ç†ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                    
                    <div class="form-group">
                        <label for="audio_cleaner">
                            <input type="checkbox" id="audio_cleaner" name="audio_cleaner">
                            <span class="checkmark"></span>
                            ğŸ§ ãƒã‚¤ã‚ºé™¤å»ï¼ˆAudio Cleanerï¼‰
                        </label>
                        <p class="help-text">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŸ³å£°ã‹ã‚‰ãƒã‚¤ã‚ºã‚’é™¤å»ã—ã¾ã™</p>
                    </div>
                    
                    <button type="submit" class="btn btn-success" {% if not session.files.music or not session.files.target_voice_upload %}disabled{% endif %}>
                        <i class="fas fa-play"></i> å‰å‡¦ç†ã‚’é–‹å§‹
                    </button>
                </div>
            </form>
            
            <!-- å‰å‡¦ç†çµæœ -->
            {% if (session.step_completed | default({})).get('preprocessing', false) %}
                <div class="result-card">
                    <h4>å‰å‡¦ç†å®Œäº†</h4>
                    <div class="file-list">
                        {% if session.files.vocal %}
                            <div class="file-item">
                                <i class="fas fa-music"></i>
                                <span>ãƒœãƒ¼ã‚«ãƒ«ï¼ˆæ¥½æ›²ï¼‰: {{ session.files.vocal.original_name }}</span>
                            </div>
                        {% endif %}
                        {% if session.files.instrumental %}
                            <div class="file-item">
                                <i class="fas fa-music"></i>
                                <span>ã‚¤ãƒ³ã‚¹ãƒˆãƒ«ãƒ¡ãƒ³ã‚¿ãƒ«: {{ session.files.instrumental.original_name }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </section>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: éŸ³å£°å¤‰æ› -->
        <section class="step-section {% if not (session.step_completed | default({})).get('preprocessing', false) %}disabled{% endif %}" id="step3">
            <h2><i class="fas fa-exchange-alt"></i> ã‚¹ãƒ†ãƒƒãƒ—3: éŸ³å£°å¤‰æ›</h2>
            
            <form action="{{ url_for('convert_voice_route') }}" method="post">
                <div class="conversion-card">
                    <h3>å¤‰æ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                    
                    <div class="form-group">
                        <label for="pitch_shift">éŸ³ç¨‹èª¿æ•´: <span id="pitch_value">0</span></label>
                        <input type="range" id="pitch_shift" name="pitch_shift" min="-12" max="12" value="0" 
                               oninput="document.getElementById('pitch_value').textContent = this.value">
                        <p class="help-text">åŠéŸ³å˜ä½ã§éŸ³ç¨‹ã‚’èª¿æ•´ (-12ã€œ+12)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="formant_shift">ãƒ•ã‚©ãƒ«ãƒãƒ³ãƒˆã‚·ãƒ•ãƒˆ: <span id="formant_value">0</span></label>
                        <input type="range" id="formant_shift" name="formant_shift" min="-10" max="10" value="0" 
                               oninput="document.getElementById('formant_value').textContent = this.value">
                        <p class="help-text">å£°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª¿æ•´ (-10ã€œ+10)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="algorithm">å¤‰æ›ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </label>
                        <select id="algorithm" name="algorithm" required>
                            <option value="rvc">RVC (æ¨å¥¨)</option>
                            <option value="so-vits">SO-VITS</option>
                            <option value="basic"> Basicå¤‰æ›</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-warning" {% if not (session.step_completed | default({})).get('preprocessing', false) %}disabled{% endif %}>
                        <i class="fas fa-magic"></i> éŸ³å£°å¤‰æ›ã‚’é–‹å§‹
                    </button>
                </div>
            </form>
            
            <!-- å¤‰æ›çµæœ -->
            {% if (session.step_completed | default({})).get('conversion', false) %}
                <div class="result-card">
                    <h4>éŸ³å£°å¤‰æ›å®Œäº†</h4>
                    <div class="file-list">
                        {% if session.files.converted_vocal %}
                            <div class="file-item">
                                <i class="fas fa-microphone"></i>
                                <span>å¤‰æ›æ¸ˆã¿ãƒœãƒ¼ã‚«ãƒ«: {{ session.files.converted_vocal.original_name }}</span>
                                <a href="{{ url_for('download_file', filename=session.files.converted_vocal.original_name) }}" class="btn btn-sm btn-outline">
                                    <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </section>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—4: å¾Œå‡¦ç† -->
        <section class="step-section {% if not (session.step_completed | default({})).get('conversion', false) %}disabled{% endif %}" id="step4">
            <h2><i class="fas fa-sliders-h"></i> ã‚¹ãƒ†ãƒƒãƒ—4: å¾Œå‡¦ç†ãƒ»ãƒŸãƒƒã‚¯ã‚¹</h2>
            
            <form action="{{ url_for('postprocess') }}" method="post">
                <div class="postprocessing-card">
                    <h3>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ»ãƒŸãƒƒã‚¯ã‚¹</h3>
                    
                    <div class="form-group">
                        <label for="vocal_effects">ãƒœãƒ¼ã‚«ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                        <select id="vocal_effects" name="vocal_effects">
                            <option value="none">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã—</option>
                            <option value="reverb">ãƒªãƒãƒ¼ãƒ–</option>
                            <option value="chorus">ã‚³ãƒ¼ãƒ©ã‚¹</option>
                            <option value="delay">ãƒ‡ã‚£ãƒ¬ã‚¤</option>
                            <option value="distortion">ãƒ‡ã‚£ã‚¹ãƒˆãƒ¼ã‚·ãƒ§ãƒ³</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="vocal_volume">ãƒœãƒ¼ã‚«ãƒ«éŸ³é‡: <span id="vocal_volume_value">100</span>%</label>
                        <input type="range" id="vocal_volume" name="vocal_volume" min="0" max="200" value="100" 
                               oninput="document.getElementById('vocal_volume_value').textContent = this.value">
                    </div>
                    
                    <div class="form-group">
                        <label for="instrumental_volume">ã‚¤ãƒ³ã‚¹ãƒˆãƒ«ãƒ¡ãƒ³ã‚¿ãƒ«éŸ³é‡: <span id="instrumental_volume_value">100</span>%</label>
                        <input type="range" id="instrumental_volume" name="instrumental_volume" min="0" max="200" value="100" 
                               oninput="document.getElementById('instrumental_volume_value').textContent = this.value">
                    </div>
                    
                    <button type="submit" class="btn btn-info" {% if not (session.step_completed | default({})).get('conversion', false) %}disabled{% endif %}>
                        <i class="fas fa-mix"></i> å¾Œå‡¦ç†ã‚’é–‹å§‹
                    </button>
                </div>
            </form>
            
            <!-- ãƒŸãƒƒã‚¯ã‚¹çµæœ -->
            {% if (session.step_completed | default({})).get('postprocessing', false) %}
                <div class="result-card">
                    <h4>ãƒŸãƒƒã‚¯ã‚¹å®Œäº†</h4>
                    <div class="file-list">
                        {% if session.files.final_output %}
                            <div class="file-item">
                                <i class="fas fa-compact-disc"></i>
                                <span>æœ€çµ‚ãƒŸãƒƒã‚¯ã‚¹: {{ session.files.final_output.original_name }}</span>
                                <a href="{{ url_for('download_file', filename=session.files.final_output.original_name) }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </section>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—5: AIåˆ†æ -->
        <section class="step-section" id="step5">
            <h2><i class="fas fa-brain"></i> ã‚¹ãƒ†ãƒƒãƒ—5: AIåˆ†æãƒ»è¦–è¦šåŒ–</h2>
            
            <form action="{{ url_for('analyze') }}" method="post">
                <div class="analysis-card">
                    <h3>æ­Œè©åˆ†æ</h3>
                    
                    <div class="form-group">
                        <label for="lyrics_text">æ­Œè©ãƒ†ã‚­ã‚¹ãƒˆ</label>
                        <textarea id="lyrics_text" name="lyrics_text" rows="8" 
                                  placeholder="æ­Œè©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-purple">
                        <i class="fas fa-search"></i> AIåˆ†æã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </form>
            
            <!-- åˆ†æçµæœ -->
            {% if session.analysis %}
                <div class="result-card">
                    <h4>AIåˆ†æçµæœ</h4>
                    <div class="analysis-results">
                        <div class="mood-analysis">
                            <h5>ãƒ ãƒ¼ãƒ‰åˆ†æ</h5>
                            <p><strong>ãƒ ãƒ¼ãƒ‰:</strong> {{ session.analysis.mood_analysis.get('mood', 'ä¸æ˜') }}</p>
                            <p><strong>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢:</strong> {{ session.analysis.mood_analysis.get('emotion_score', 0.0) }}</p>
                            <p><strong>ã‚¸ãƒ£ãƒ³ãƒ«:</strong> {{ session.analysis.mood_analysis.get('genre', 'ä¸æ˜') }}</p>
                        </div>
                        
                        <div class="song-insights">
                            <h5>ã‚½ãƒ³ã‚°ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h5>
                            <p><strong>æ¨å¥¨ãƒœãƒ¼ã‚«ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«:</strong> {{ session.analysis.song_insights.get('vocal_style', 'ä¸æ˜') }}</p>
                            <p><strong>æ„Ÿæƒ…çš„ãªå±•é–‹:</strong> {{ session.analysis.song_insights.get('emotional_arc', 'ä¸æ˜') }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </section>

        <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
        <div class="reset-section">
            <a href="{{ url_for('reset') }}" class="btn btn-danger btn-lg" 
               onclick="return confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')">
                <i class="fas fa-refresh"></i> ãƒªã‚»ãƒƒãƒˆ
            </a>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 MyVoiceger - FFmpeg-FreeéŸ³å£°å¤‰æ›ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</p>
            <p class="tech-info">
                <i class="fas fa-microchip"></i> 
                æŠ€è¡“: Flask + librosa + soundfile | 
                <i class="fas fa-shield-alt"></i> 
                Gradioã‚’å®Œå…¨ã«å›é¿ã—ãŸè»½é‡æ§‹æˆ
            </p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>